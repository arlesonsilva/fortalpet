var geoip_country_name,geoip_city,requestUpdate=!1;valid_form=!0;
(function(s,a){var m,n;function x(){a(document).ajaxSend(function(c,k,d){a("#general-ajax-load").fadeIn();valid_form=!1;requestUpdate=!0}).ajaxComplete(function(c,k,d){a("#general-ajax-load").fadeOut();valid_form=!0;requestUpdate=!1});a.ajaxSetup({cache:!1})}function f(a,k,d,b){1!=a&&!0!=a||null===document.id(k)||document.id(k).set(d,b)}function y(){"object"==typeof geoip2&&geoip2.city(function(c){var k=a("#city_field"),d,b=a("#virtuemart_country_id");d=b.find('[data-iso="'+c.country.iso_code+'"]:eq(0)').val();
""==b.val()&&(k.val(c.city.names.en),b.val(d),jQuery("#virtuemart_country_id").find('option[value="'+d+'"]').attr("selected","selected").change().trigger("liszt:updated"))},function(a){})}function u(){p.filter(":not('#STsameAsBT')").each(function(){var c=a(this),k=c.attr("id"),d="shipto_"+k;if(!0==e.cbSTsameAsBT.prop("checked")){if("virtuemart_country_id"==k){var b=c.html();a("#"+d).html(b)}"virtuemart_state_id"==k&&(b=c.html(),a("#"+d).html(b));a("#"+d).val(c.val()).trigger("liszt:updated")}})}function v(){!0==
e.cbRegister.prop("checked")?g.find("#table_user").fadeIn():g.find("#table_user").fadeOut();return e.cbRegister}function w(){!0==e.cbSTsameAsBT.prop("checked")?(g.find("#table_shipto").fadeOut(),u(),a("#shipto_virtuemart_country_id").trigger("change")):g.find("#table_shipto").fadeIn();return e.cbSTsameAsBT}function z(){var c="index.php?api_controller=checkout&api_ajax=set_coupon&coupon="+e.tbCoupon.val();a.getJSON(c,function(a){null!==a.salesPriceCoupon&&""!==a.salesPriceCoupon?(g.find("#coupon_price").html(a.salesPriceCoupon),
e.lblCoupon.fadeIn()):(alert(Joomla.JText._("SYSTEM_ONESTEPCHECKOUT_COUPON_INVALID")),e.lblCoupon.fadeOut(),g.find("#coupon_price").empty());null!==a.billTotal&&""!==a.billTotal&&g.find("#bill_total").html(a.billTotal)})}function A(){var c=a(this),k=c.attr("id"),d="shipto_"+k;if(!0==e.cbSTsameAsBT.prop("checked")){if("virtuemart_country_id"==k){var b=g.find("#virtuemart_state_id").empty();e.default_opt.appendTo(b)}"virtuemart_state_id"==k&&(k=c.html(),a("#"+d).html(k));a("#"+d).val(c.val()).trigger("change").trigger("liszt:updated")}}
function l(c,e){if("update_product"==c&&0>=document.id("quantity_"+e).value)return alert(Joomla.JText._("SYSTEM_ONESTEPCHECKOUT_DATA_INVALID"));var d;c||(c="update_form");d="index.php?api_controller=checkout&api_ajax="+c;e&&(d+="&id="+e);"update_product"==c&&(d+="&quantity="+document.id("quantity_"+e).value);d+="&update_address=1";requestUpdate||(requestUpdate=!0,a("#shipping_method .pane-inner").css("visibility","hidden"),a.ajax({url:d,type:"POST",cache:!1,data:a("#checkoutForm").serialize(),dataType:"json",
success:function(b){requestUpdate=!1;if(!b.error){"remove_product"==c&&document.id("product_row_"+e).destroy();Virtuemart&&Virtuemart.productUpdate(a(".vmCartModule"));if(b.price.products)for(var h in b.price.products)f(vmconfig.show_tax,"subtotal_tax_amount_"+h,"text",b.price.products[h].subtotal_tax_amount),f(!0,"subtotal_discount_"+h,"text",b.price.products[h].subtotal_discount),f(!0,"subtotal_with_tax_"+h,"html",b.price.products[h].subtotal_with_tax);f(vmconfig.show_tax,"tax_amount","text",b.price.taxAmount);
f(vmconfig.show_tax,"discount_amount","text",b.price.discountAmount);f(!0,"sales_price","text",b.price.salesPrice);f(vmconfig.show_tax,"shipment_tax","text",b.price.shipmentTax);f(!0,"shipment","text",b.price.salesPriceShipment);f(vmconfig.show_tax,"payment_tax","text",b.price.paymentTax);f(!0,"payment","text",b.price.salesPricePayment);f(vmconfig.show_tax,"total_tax","text",b.price.billTaxAmount);f(!0,"total_amount","text",b.price.billDiscountAmount);f(!0,"bill_total","text",b.price.billTotal);document.id("shipments").empty();
var d="";if(b.shipments){for(h=0;h<b.shipments.length;h++)d+=b.shipments[h].toString()+"<br />";document.id("shipments").set("html",d)}document.id("payments").empty();d="";if(b.payments){for(h=0;h<b.payments.length;h++)d+=b.payments[h].toString()+"<br />";document.id("payments").set("html",d)}a('input[type="radio"]',"#shipments").click(function(){l()});a('input[type="radio"]',"#payments").click(function(){l()});a("#shipping_method .pane-inner").css("visibility","visible").fadeIn()}}}))}function B(){var c=
g.find("#tosAccepted");if(1==q.oncheckout_show_legal_info){if(q.agree_to_tos_onorder&&!1==c.prop("checked"))return alert(Joomla.JText._("SYSTEM_ONESTEPCHECKOUT_TOS_CONFIRM"))}else c.prop("checked",!0);var c=a(":input:checked","#shipments").length,k=a(":input:checked","#payments").length;if(0>=c)return alert(Joomla.JText._("SYSTEM_ONESTEPCHECKOUT_SHIPMENT_INVALID"));if(0>=k)return alert(Joomla.JText._("SYSTEM_ONESTEPCHECKOUT_PAYMENT_INVALID"));var d=!0;document.id("register")&&!0==document.id("register").checked&&
(d=!1,(new Request.JSON({url:"index.php?api_controller=checkout&api_ajax=register",method:"post",async:!1,noCache:!0,data:document.id("div_billto").toQueryString()+"&address_type=BT&"+vmconfig.token+"=1",onSuccess:function(a,b){a.error&&1==a.error?alert(a.message):d=!0},onFailure:function(a){500==a.status&&(d=!0)}})).send());if(d){!0==e.cbSTsameAsBT.prop("checked")&&u();var b=new JFormValidator;b.attachToForm(document.id("table_billto"));var h=!0;document.id("table_billto").getElements("input").each(function(a){a=
b.validate(a);h=h&&a});if(h&&0>=document.id("virtuemart_country_id").value)return h=!1,alert(Joomla.JText._("SYSTEM_ONESTEPCHECKOUT_COUNTRY_INVALID"));if(!h)return a("html,body").animate({scrollTop:a("#table_billto").offset().top},"slow"),h=!1,alert(Joomla.JText._("SYSTEM_ONESTEPCHECKOUT_FORM_INVALID"));b.attachToForm(document.id("table_shipto"));var f=!0;document.id("table_shipto").getElements("input").each(function(a){a=b.validate(a);f=f&&a});if(f&&0>=document.id("shipto_virtuemart_country_id").value)return a("html,body").animate({scrollTop:a("#shipto_virtuemart_country_id").offset().top},
"slow"),f=!1,alert(Joomla.JText._("SYSTEM_ONESTEPCHECKOUT_SHIPTO_COUNTRY_INVALID")),!1;c=a("#shipto_virtuemart_state_id");if(f&&(0>=c.val()||""==c.val())&&"required"==document.getElementById("shipto_virtuemart_state_id").getAttribute("required"))return a("html,body").animate({scrollTop:a("#shipto_virtuemart_country_id").offset().top},"slow"),f=!1,alert(Joomla.JText._("SYSTEM_ONESTEPCHECKOUT_SHIPTO_STATE_INVALID")),!1;if(!f)return a("html,body").animate({scrollTop:a("#table_shipto").offset().top},
"slow"),alert(Joomla.JText._("SYSTEM_ONESTEPCHECKOUT_INFO_INVALID")),!1;if(!1==(h&&f))return!1;c=!0==e.cbSTsameAsBT.prop("checked")?1:0;a.getJSON("index.php?api_controller=checkout&api_ajax=set_checkout&tosAccepted=1&STsameAsBT="+c,{data:a("#checkoutForm").serialize(),method:"GET"},function(a){"success"==a.status&&g.submit()})}}function C(){1==q.geoip&&y();r=a.cookies.get("visited");null==r&&!1==e.cbSTsameAsBT.prop("checked")&&e.cbSTsameAsBT.prop("checked",!0);r=1;a.cookies.get("visited",r);a("#login-modal-trigger").click(function(){a("#login-modal").dialog({title:"Login",
dialogClass:"ui-login-dialog",position:["center","center"],modal:!0,resizable:!1,width:"370",create:function(a,c){}}).find('input[type="submit"]').click(function(b){b.preventDefault();b=a(".ui-login-dialog #com-form-login");var c=b.find('input[name="username"]'),d=b.find('input[name="password"]');""===c.val()&&b.find("#advice-required-entry-login-username").fadeIn();""===d.val()&&b.find("#advice-required-entry-login-password").fadeIn();return""!==c.val()&&""!==d.val()?(b.find("#advice-required-entry-login-username").fadeOut().end().find("#advice-required-entry-login-password").fadeOut(),
b.submit(),!0):!1}).end().find("#remind-password-trigger").click(function(b){b.preventDefault();a("#login-modal").dialog("close");m=a("#login-remind-modal").dialog({title:"Remind Password",dialogClass:"ui-remind-dialog",position:["center","center"],modal:!0,width:"400",resizable:!1});m.find(".btn-back").click(function(b){b.preventDefault();m.dialog("close");a("#login-modal").dialog("open")})}).end().find("#reset-password-trigger").click(function(b){b.preventDefault();a("#login-modal").dialog("close");
n=a("#login-reset-modal").dialog({title:"Reset Password",dialogClass:"ui-reset-dialog",position:["center","center"],modal:!0,width:"400",resizable:!1});n.find(".btn-back").click(function(b){b.preventDefault();n.dialog("close");a("#login-modal").dialog("open")})})});a('.product-quanlity input[name="update"]').click(function(){var b=a(this).data("pid");l("update_product",b)});a('.product-quanlity a[name="remove"]').click(function(){var b=a(this).data("pid");l("remove_product",b)});var c=a.cookies.get("virtuemart_shipmentmethod_id");
0<a("#shipment_id_"+c).length&&a("#shipment_id_"+c).prop("checked",!0);a('input[type="radio"]',"#shipments").click(function(){a.cookies.set("virtuemart_shipmentmethod_id",a(this).val());l()});var c=a("#payments").find(".vmpayment_cardinfo"),f=c.prev().prev().prev();a('input[type="radio"]',"#payments").click(function(){l()});0<f.length&&(!0==f.prop("checked")?c.show():c.hide());e.hlTOS.click(function(){if("function"==typeOf(a.facebox))a.facebox({div:"#full-tos"},"my-groovy-style");else if("function"==
typeOf(a.fancybox)){var b=a("div#full-tos").html();a.fancybox({div:"#full-tos",content:b})}});e.btnCoupon.click(function(a){a.preventDefault();z()});v().click(v);w().click(w);e.dbSTCountry.change(function(){l()});var c=g.find("#password_field"),d=g.find("#password2_field");d.val(c.val());c.change(function(){d.val(a(this).val())});0<fBillToZip.length&&fBillToZip.val(" ");fBillToZip.bind("focus change blur",function(){""===a(this).val()&&a(this).val(" ")});0<fShipToZip.length&&fShipToZip.val(" ");fShipToZip.bind("focus change blur",
function(){""===a(this).val()&&a(this).val(" ")});0<fShipToNickName.length&&fShipToNickName.val("ST");fShipToNickName.bind("focus change blur",function(){""===a(this).val()&&a(this).val("ST")});e.btnCheckOut.click(function(a){a.preventDefault();B()});p.each(function(b,c){a(c).bind("change blur",A)});a("#virtuemart_country_id").change(function(){l()});e.btnEmptyCart.bind("click",function(){a.ajax({url:"index.php?api_controller=checkout&api_ajax=empty_cart"}).done(function(){window.location.reload()})});
l()}n=m=void 0;var r=!1,q,g,e={},p,t;s.checkout={vmConfig:{},init:function(){q=window.vmconfig||{};x();a("#cart-view-3cols").data("user-guest");a("#system-message-container").hide();a("#full-tos").hide();a("#com-form-login");a("#login-pane");a("#alert-message");a("#checkoutForm");a("#div_billto");a("#div_shipto");a("#billing_info");a("#shipping_info");a(".coupon-pane").first();n=m=void 0;g=a("#checkoutForm");a("#com-form-login");e.cbRegister=g.find("#register");e.cbSTsameAsBT=g.find("#STsameAsBT");
e.tbCoupon=g.find("#coupon_code");e.lblCoupon=g.find("#coupon_code_txt");e.btnCoupon=g.find("#coupon_code_button");e.btnCheckOut=g.find("a.vm-button-correct:eq(0)");e.hlTOS=g.find("span.terms-of-service:eq(0)");e.btnEmptyCart=g.find("#empty_cart");e.dbBTCountry=g.find("#virtuemart_country_id");e.dbSTCountry=g.find("#shipto_virtuemart_country_id");p=g.find("#table_billto input,#table_billto select");t=g.find("#table_shipto input,#table_shipto select");fBillToZip=p.filter("#zip_field");fShipToZip=t.filter("#shipto_zip_field");
fShipToNickName=t.filter("#shipto_address_type_name_field");e.default_opt=a('<option value="" checked="checked">'+Joomla.JText._("COM_VIRTUEMART_LIST_EMPTY_OPTION")+"</option>");C()},update_form:function(a,e){l()}};a().ready(function(){s.checkout.vmConfig=window.vmconfig||{};s.checkout.init()})})(window.nx=window.nx||{},jQuery);