var geoip_country_name,geoip_city,requestUpdate=!1;
(function(s,a){var m,n;function x(){a(document).ajaxSend(function(d,g,c){a("#general-ajax-load").fadeIn();requestUpdate=!0}).ajaxComplete(function(d,g,c){a("#general-ajax-load").fadeOut();requestUpdate=!1});a.ajaxSetup({cache:!1})}function h(a,g,c,b){1!=a&&!0!=a||null===document.id(g)||document.id(g).set(c,b)}function y(){"object"==typeof geoip2&&geoip2.city(function(d){var g=a("#city_field"),c,b=a("#virtuemart_country_id");c=b.find('[data-iso="'+d.country.iso_code+'"]:eq(0)').val();""==b.val()&&
(g.val(d.city.names.en),b.val(c),jQuery("#virtuemart_country_id").find('option[value="'+c+'"]').attr("selected","selected").change().trigger("liszt:updated"))},function(a){})}function u(){p.filter(":not('#STsameAsBT')").each(function(){var d=a(this),g=d.attr("id"),c="shipto_"+g;if(!0==e.cbSTsameAsBT.prop("checked")){if("virtuemart_country_id"==g){var b=d.html();a("#"+c).html(b)}"virtuemart_state_id"==g&&(b=d.html(),a("#"+c).html(b));a("#"+c).val(d.val()).trigger("liszt:updated")}})}function v(){!0==
e.cbRegister.prop("checked")?f.find("#user-register-fields").fadeIn():f.find("#user-register-fields").fadeOut();return e.cbRegister}function w(){!0==e.cbSTsameAsBT.prop("checked")?(f.find("#shipping_info").fadeOut(),u(),a("#shipto_virtuemart_country_id").trigger("change")):f.find("#shipping_info").fadeIn();return e.cbSTsameAsBT}function z(){var d="index.php?api_controller=checkout&api_ajax=set_coupon&coupon="+e.tbCoupon.val();a.getJSON(d,function(a){null!==a.salesPriceCoupon&&""!==a.salesPriceCoupon?
(f.find("#coupon_price").html(a.salesPriceCoupon),e.lblCoupon.fadeIn()):(alert(Joomla.JText._("SYSTEM_ONESTEPCHECKOUT_COUPON_INVALID")),e.lblCoupon.fadeOut(),f.find("#coupon_price").empty());null!==a.billTotal&&""!==a.billTotal&&f.find("#bill_total").html(a.billTotal)})}function A(){var d=a(this),g=d.attr("id"),c="shipto_"+g;if(!0==e.cbSTsameAsBT.prop("checked")){if("virtuemart_country_id"==g){var b=f.find("#virtuemart_state_id").empty();e.default_opt.appendTo(b)}"virtuemart_state_id"==g&&(g=d.html(),
a("#"+c).html(g));a("#"+c).val(d.val()).trigger("change").trigger("liszt:updated")}}function k(d,e){if("update_product"==d&&0>=document.id("quantity_"+e).value)return alert(Joomla.JText._("SYSTEM_ONESTEPCHECKOUT_DATA_INVALID"));var c;d||(d="update_form");c="index.php?api_controller=checkout&api_ajax="+d;e&&(c+="&id="+e);"update_product"==d&&(c+="&quantity="+document.id("quantity_"+e).value);c+="&update_address=1";requestUpdate||(requestUpdate=!0,a("#shipping_method .pane-inner").css("visibility",
"hidden"),a.ajax({url:c,type:"POST",cache:!1,data:a("#checkoutForm").serialize(),dataType:"json",success:function(b){requestUpdate=!1;if(!b.error){"remove_product"==d&&document.id("product_row_"+e).destroy();Virtuemart&&Virtuemart.productUpdate(a(".vmCartModule"));if(b.price.products)for(var c in b.price.products)h(vmconfig.show_tax,"subtotal_tax_amount_"+c,"text",b.price.products[c].subtotal_tax_amount),h(!0,"subtotal_discount_"+c,"text",b.price.products[c].subtotal_discount),h(!0,"subtotal_with_tax_"+
c,"html",b.price.products[c].subtotal_with_tax);h(vmconfig.show_tax,"tax_amount","text",b.price.taxAmount);h(vmconfig.show_tax,"discount_amount","text",b.price.discountAmount);h(!0,"sales_price","text",b.price.salesPrice);h(vmconfig.show_tax,"shipment_tax","text",b.price.shipmentTax);h(!0,"shipment","text",b.price.salesPriceShipment);h(vmconfig.show_tax,"payment_tax","text",b.price.paymentTax);h(!0,"payment","text",b.price.salesPricePayment);h(vmconfig.show_tax,"total_tax","text",b.price.billTaxAmount);
h(!0,"total_amount","text",b.price.billDiscountAmount);h(!0,"bill_total","text",b.price.billTotal);document.id("shipments").empty();var f="";if(b.shipments){for(c=0;c<b.shipments.length;c++)f+=b.shipments[c].toString()+"<br />";document.id("shipments").set("html",f)}document.id("payments").empty();f="";if(b.payments){for(c=0;c<b.payments.length;c++)f+=b.payments[c].toString()+"<br />";document.id("payments").set("html",f)}a('input[type="radio"]',"#shipments").click(function(){k()});a('input[type="radio"]',
"#payments").click(function(){k()});a("#shipping_method .pane-inner").css("visibility","visible").fadeIn()}}}))}function B(){var d=f.find("#tosAccepted");if(1==q.oncheckout_show_legal_info){if(q.agree_to_tos_onorder&&!1==d.prop("checked"))return alert(Joomla.JText._("SYSTEM_ONESTEPCHECKOUT_TOS_CONFIRM"))}else d.prop("checked",!0);var d=a(":input:checked","#shipments").length,g=a(":input:checked","#payments").length;if(0>=d)return alert(Joomla.JText._("SYSTEM_ONESTEPCHECKOUT_SHIPMENT_INVALID"));if(0>=
g)return alert(Joomla.JText._("SYSTEM_ONESTEPCHECKOUT_PAYMENT_INVALID"));var c=!0;document.id("register")&&!0==document.id("register").checked&&(c=!1,(new Request.JSON({url:"index.php?api_controller=checkout&api_ajax=register",method:"post",async:!1,noCache:!0,data:document.id("div_billto").toQueryString()+"&address_type=BT&"+vmconfig.token+"=1",onSuccess:function(a,b){a.error&&1==a.error?alert(a.message):c=!0},onFailure:function(a){500==a.status&&(c=!0)}})).send());if(c){!0==e.cbSTsameAsBT.prop("checked")&&
u();var b=new JFormValidator;b.attachToForm(document.id("table_billto"));var h=!0;document.id("table_billto").getElements("input").each(function(a){a=b.validate(a);h=h&&a});if(h&&0>=document.id("virtuemart_country_id").value)return alert(Joomla.JText._("SYSTEM_ONESTEPCHECKOUT_COUNTRY_INVALID"));if(h){b.attachToForm(document.id("table_shipto"));var l=!0;document.id("table_shipto").getElements("input").each(function(a){a=b.validate(a);l=l&&a});if(l&&0>=document.id("shipto_virtuemart_country_id").value)return a("html,body").animate({scrollTop:a("#shipto_virtuemart_country_id").offset().top},
"slow"),l=!1,alert(Joomla.JText._("SYSTEM_ONESTEPCHECKOUT_SHIPTO_COUNTRY_INVALID")),!1;d=a("#shipto_virtuemart_state_id");if(l&&(0>=d.val()||""==d.val())&&"required"==document.getElementById("shipto_virtuemart_state_id").getAttribute("required"))return a("html,body").animate({scrollTop:a("#shipto_virtuemart_country_id").offset().top},"slow"),l=!1,alert(Joomla.JText._("SYSTEM_ONESTEPCHECKOUT_SHIPTO_STATE_INVALID")),!1;if(!l)return a("html,body").animate({scrollTop:a("#table_shipto").offset().top},
"slow"),alert(Joomla.JText._("SYSTEM_ONESTEPCHECKOUT_INFO_INVALID")),!1;if(!1==(h&&l))return!1;d=!0==e.cbSTsameAsBT.prop("checked")?1:0;a.getJSON("index.php?api_controller=checkout&api_ajax=set_checkout&tosAccepted=1&STsameAsBT="+d,{data:a("#checkoutForm").serialize(),method:"GET"},function(a){"success"==a.status&&f.submit()})}else a("html,body").animate({scrollTop:a("#table_billto").offset().top},"slow"),alert(Joomla.JText._("SYSTEM_ONESTEPCHECKOUT_FORM_INVALID"))}}function C(){1==q.geoip&&y();r=
a.cookies.get("visited");null==r&&!1==e.cbSTsameAsBT.prop("checked")&&e.cbSTsameAsBT.prop("checked",!0);r=1;a.cookies.get("visited",r);a("#login-modal-trigger").click(function(){a("#login-modal").dialog({title:"Login",dialogClass:"ui-login-dialog",position:["center","center"],modal:!0,resizable:!1,width:"370",create:function(a,c){}}).find('input[type="submit"]').click(function(b){b.preventDefault();b=a(".ui-login-dialog #com-form-login");var c=b.find('input[name="username"]'),d=b.find('input[name="password"]');
""===c.val()&&b.find("#advice-required-entry-login-username").fadeIn();""===d.val()&&b.find("#advice-required-entry-login-password").fadeIn();return""!==c.val()&&""!==d.val()?(b.find("#advice-required-entry-login-username").fadeOut().end().find("#advice-required-entry-login-password").fadeOut(),b.submit(),!0):!1}).end().find("#remind-password-trigger").click(function(b){b.preventDefault();a("#login-modal").dialog("close");m=a("#login-remind-modal").dialog({title:"Remind Password",dialogClass:"ui-remind-dialog",
position:["center","center"],modal:!0,width:"400",resizable:!1});m.find(".btn-back").click(function(b){b.preventDefault();m.dialog("close");a("#login-modal").dialog("open")})}).end().find("#reset-password-trigger").click(function(b){b.preventDefault();a("#login-modal").dialog("close");n=a("#login-reset-modal").dialog({title:"Reset Password",dialogClass:"ui-reset-dialog",position:["center","center"],modal:!0,width:"400",resizable:!1});n.find(".btn-back").click(function(b){b.preventDefault();n.dialog("close");
a("#login-modal").dialog("open")})})});a('.product-quanlity input[name="update"]').click(function(){var b=a(this).data("pid");k("update_product",b)});a('.product-quanlity a[name="remove"]').click(function(){var b=a(this).data("pid");k("remove_product",b)});var d=a.cookies.get("virtuemart_shipmentmethod_id");0<a("#shipment_id_"+d).length&&a("#shipment_id_"+d).prop("checked",!0);a('input[type="radio"]',"#shipments").click(function(){a.cookies.set("virtuemart_shipmentmethod_id",a(this).val());k()});
var d=a("#payments").find(".vmpayment_cardinfo"),g=d.prev().prev().prev();a('input[type="radio"]',"#payments").click(function(){k()});0<g.length&&(!0==g.prop("checked")?d.show():d.hide());e.hlTOS.click(function(){if("function"==typeOf(a.facebox))a.facebox({div:"#full-tos"},"my-groovy-style");else if("function"==typeOf(a.fancybox)){var b=a("div#full-tos").html();a.fancybox({div:"#full-tos",content:b})}});e.btnCoupon.click(function(a){a.preventDefault();z()});v().click(v);w().click(w);e.dbSTCountry.change(function(){k()});
var d=f.find("#password_field"),c=f.find("#password2_field");c.val(d.val());d.change(function(){c.val(a(this).val())});0<fBillToZip.length&&fBillToZip.val(" ");fBillToZip.bind("focus change blur",function(){""===a(this).val()&&a(this).val(" ")});0<fShipToZip.length&&fShipToZip.val(" ");fShipToZip.bind("focus change blur",function(){""===a(this).val()&&a(this).val(" ")});0<fShipToNickName.length&&fShipToNickName.val("ST");fShipToNickName.bind("focus change blur",function(){""===a(this).val()&&a(this).val("ST")});
e.btnCheckOut.click(function(a){a.preventDefault();B()});p.bind("change",A);a("#virtuemart_country_id").change(function(){k()});e.btnEmptyCart.bind("click",function(){a.ajax({url:"index.php?api_controller=checkout&api_ajax=empty_cart"}).done(function(){window.location.reload()})});k()}n=m=void 0;var r=!1,q,f,e={},p,t;s.checkout={vmConfig:{},init:function(){q=window.vmconfig||{};x();a("#cart-view-3cols").data("user-guest");a("#system-message-container").hide();a("div#full-tos").hide();a("#com-form-login");
a("#login-pane");a("#alert-message");a("#checkoutForm");a("#div_billto");a("#div_shipto");a("#billing_info");a("#shipping_info");a(".coupon-pane").first();n=m=void 0;f=a("#checkoutForm");a("#com-form-login");e.cbRegister=f.find("#register");e.cbSTsameAsBT=f.find("#STsameAsBT");e.tbCoupon=f.find("#coupon_code");e.lblCoupon=f.find("#coupon_code_txt");e.btnCoupon=f.find("#coupon_code_button");e.btnCheckOut=f.find("a.vm-button-correct:eq(0)");e.hlTOS=f.find("span.terms-of-service:eq(0)");e.btnEmptyCart=
f.find("#empty_cart");e.dbBTCountry=f.find("#virtuemart_country_id");e.dbSTCountry=f.find("#shipto_virtuemart_country_id");p=f.find("#table_billto input,#table_billto select");t=f.find("#table_shipto input,#table_shipto select");fBillToZip=p.filter("#billto_zip_field");fShipToZip=t.filter("#shipto_zip_field");fShipToNickName=t.filter("#shipto_address_type_name_field");e.default_opt=a('<option value="" checked="checked">'+Joomla.JText._("COM_VIRTUEMART_LIST_EMPTY_OPTION")+"</option>");C()},update_form:function(a,
e){k()}};a().ready(function(){s.checkout.vmConfig=window.vmconfig||{};s.checkout.init()})})(window.nx=window.nx||{},jQuery);